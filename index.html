<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>달서디지털체험센터 체험부스 방명록</title>
  <style>
    :root { --radius: 16px; }
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR',sans-serif;margin:0;background:#f6f7fb;color:#111}
    .wrap{max-width:560px;margin:0 auto;padding:24px}
    .card{background:#fff;border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06);padding:24px}
    h1{font-size:20px;margin:0 0 4px}
    .subtitle{color:#666;margin:0 0 16px;font-size:14px}
    .field{margin:16px 0}
    .label{display:block;font-weight:600;margin-bottom:8px}
    .select, .button {width:100%;border-radius:12px;border:1px solid #d7d9e0;padding:14px 12px;font-size:16px;background:#fff}
    .button{background:#111;color:#fff;cursor:pointer;border:none}
    .button[disabled]{opacity:.6;cursor:not-allowed}
    .seg{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .seg2{grid-template-columns:repeat(2,1fr)}
    .chip{border:1px solid #d7d9e0;border-radius:999px;padding:10px 12px;background:#fff;text-align:center;cursor:pointer;user-select:none}
    .chip.selected{background:#111;color:#fff;border-color:#111}
    .note{font-size:12px;color:#666;margin-top:12px}
    .footer{margin-top:20px;font-size:12px;color:#999;text-align:center}
    .success{background:#e8f7ec;color:#137a31;border:1px solid #bde3c7;padding:12px;border-radius:12px;margin-top:12px;display:none}
    .error{background:#fdeaea;color:#b42318;border:1px solid #f5c2c0;padding:12px;border-radius:12px;margin-top:12px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>달서디지털체험센터 체험부스 방명록</h1>
      <p class="subtitle">방문객 현황 집계를 위해 거주지역과 연령대를 선택해 주세요.</p>

      <form id="guestbookForm">
        <div class="field">
          <span class="label">거주지역</span>
          <div id="regions" class="seg seg2" role="radiogroup" aria-label="거주지역"></div>
        </div>

        <div class="field">
          <span class="label">연령대</span>
          <div id="ages" class="seg" role="radiogroup" aria-label="연령대">
            <!-- 버튼형 라디오 -->
          </div>
        </div>

        <button type="submit" id="submitBtn" class="button">등록</button>
        <div id="ok" class="success">등록되었습니다. 참여해주셔서 감사합니다!</div>
        <div id="fail" class="error">전송에 문제가 발생했습니다. 다시 시도해 주세요.</div>
        <p class="note">입력하신 정보는 통계 집계 목적에만 사용됩니다. (개인식별정보 수집 없음)</p>
      </form>
    </div>
    <p class="footer">© 달서디지털체험센터</p>
  </div>

  <script>
    // == 설정: 아래에 Google Apps Script Web App URL을 붙여넣으세요 ==
    const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwysbN00pJoAjLoKiUFLRfPdGaL-AwTiFdu7PjiNOlt5MTXSLV9KcTZ5v1-Ca4gZ55YpQ/exec";

    // -------- 간단한 Client Info 수집 (userAgent 전체가 아니라 요약값만) --------
    async function getClientInfo() {
      const info = { device: 'unknown', os: 'unknown', browser: 'unknown' };

      try {
        // 1) User-Agent Client Hints 우선 사용 (Chromium 계열에서 동작)
        if (navigator.userAgentData) {
          info.device = navigator.userAgentData.mobile ? 'mobile' : 'desktop';
          const uaData = await navigator.userAgentData.getHighEntropyValues(
            ['platform','fullVersionList']
          );
          if (uaData && uaData.platform) info.os = uaData.platform; // e.g., 'Android', 'Windows', 'iOS', 'macOS'
          const brands = (uaData && uaData.fullVersionList) || navigator.userAgentData.brands || [];
          // Chromium/브랜드 토큰 중 Chromium이 아닌 첫 항목을 선호
          const b = brands.find(b => !/Chromium/i.test(b.brand)) || brands[0];
          if (b && b.brand) info.browser = b.brand;
          return info;
        }
      } catch (e) {
        // no-op: 아래 UA 파싱으로 폴백
      }

      // 2) 폴백: 전통 UA 문자열에서 최소한의 라벨만 추출
      const ua = navigator.userAgent || '';
      // device
      info.device = /Mobile|Android|iPhone|iPad|iPod|IEMobile|BlackBerry/i.test(ua) ? 'mobile' : 'desktop';

      // os
      if (/Android/i.test(ua)) info.os = 'Android';
      else if (/(iPhone|iPad|iPod)/i.test(ua)) info.os = 'iOS';
      else if (/Windows/i.test(ua)) info.os = 'Windows';
      else if (/Macintosh|Mac OS X/i.test(ua)) info.os = 'macOS';
      else if (/Linux/i.test(ua)) info.os = 'Linux';

      // browser
      if (/SamsungBrowser/i.test(ua)) info.browser = 'Samsung Internet';
      else if (/Edg\//i.test(ua)) info.browser = 'Edge';
      else if (/Chrome\//i.test(ua)) info.browser = 'Chrome';
      else if (/Firefox\//i.test(ua)) info.browser = 'Firefox';
      else if (/Safari\//i.test(ua)) info.browser = 'Safari';

      return info;
    }

    // 거주지역 버튼 구성
    const regionOptions = ["달서구","달서구외"];
    const regionsEl = document.getElementById('regions');
    let selectedRegion = null;
    regionOptions.forEach(label=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'chip';
      b.textContent = label;
      b.setAttribute('role','radio');
      b.setAttribute('aria-checked','false');
      b.addEventListener('click',()=>{
        selectedRegion = label;
        regionsEl.querySelectorAll('.chip').forEach(c=>{c.classList.remove('selected');c.setAttribute('aria-checked','false')});
        b.classList.add('selected');
        b.setAttribute('aria-checked','true');
      });
      regionsEl.appendChild(b);
    });

    // 연령대 버튼 구성
    const ageOptions = ["유아","초등","중등","고등","성인"];
    const agesEl = document.getElementById('ages');
    let selectedAge = null;
    ageOptions.forEach(label=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'chip';
      b.textContent = label;
      b.setAttribute('role','radio');
      b.setAttribute('aria-checked','false');
      b.addEventListener('click',()=>{
        selectedAge = label;
        agesEl.querySelectorAll('.chip').forEach(c=>{c.classList.remove('selected');c.setAttribute('aria-checked','false')});
        b.classList.add('selected');
        b.setAttribute('aria-checked','true');
      });
      agesEl.appendChild(b);
    });

    // 제출 처리
    const form = document.getElementById('guestbookForm');
    const submitBtn = document.getElementById('submitBtn');
    const ok = document.getElementById('ok');
    const fail = document.getElementById('fail');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      ok.style.display = 'none';
      fail.style.display = 'none';

      if(!selectedRegion){
        alert('거주지역을 선택해 주세요.');
        return;
      }
      if(!selectedAge){
        alert('연령대를 선택해 주세요.');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = '전송 중…';

      try{
        const client = await getClientInfo(); // 간단 요약 정보만 수집
        // 전송 payload (방문일자/시간은 서버에서 결정)
        const payload = {
          region: selectedRegion,
          age: selectedAge,
          client // { device, os, browser }
        };

        // Apps Script의 CORS 제약을 감안해 no-cors 모드 사용.
        await fetch(GAS_WEBAPP_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        ok.style.display = 'block';
        form.reset();
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected'));
        // 선택 상태 초기화
        selectedRegion = null;
        selectedAge = null;
      } catch(err){
        console.error(err);
        fail.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '등록';
      }
    });
  </script>
</body>
</html>
