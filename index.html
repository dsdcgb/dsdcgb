<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>달서디지털체험센터 체험부스 방명록</title>
  <style>
    :root { --radius: 16px; }
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR',sans-serif;margin:0;background:#f6f7fb;color:#111}
    .wrap{max-width:560px;margin:0 auto;padding:24px}
    .card{background:#fff;border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06);padding:24px}
    h1{font-size:20px;margin:0 0 4px}
    .subtitle{color:#666;margin:0 0 16px;font-size:14px}
    .field{margin:16px 0}
    .label{display:block;font-weight:600;margin-bottom:8px}
    .select, .button {width:100%;border-radius:12px;border:1px solid #d7d9e0;padding:14px 12px;font-size:16px;background:#fff}
    .button{background:#111;color:#fff;cursor:pointer;border:none}
    .button[disabled]{opacity:.6;cursor:not-allowed}
    .seg{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .seg2{grid-template-columns:repeat(2,1fr)}
    .chip{border:1px solid #d7d9e0;border-radius:999px;padding:10px 12px;background:#fff;text-align:center;cursor:pointer;user-select:none}
    .chip.selected{background:#111;color:#fff;border-color:#111}
    .note{font-size:12px;color:#666;margin-top:12px}
    .footer{margin-top:20px;font-size:12px;color:#999;text-align:center}
    .success{background:#e8f7ec;color:#137a31;border:1px solid #bde3c7;padding:12px;border-radius:12px;margin-top:12px;display:none}
    .error{background:#fdeaea;color:#b42318;border:1px solid #f5c2c0;padding:12px;border-radius:12px;margin-top:12px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>달서디지털체험센터 체험부스 방명록</h1>
      <p class="subtitle">방문객 현황 집계를 위해 거주지역과 연령대를 선택해 주세요.</p>

      <form id="guestbookForm">
        <div class="field">
          <span class="label">거주지역</span>
          <div id="regions" class="seg seg2" role="radiogroup" aria-label="거주지역"></div>
        </div>

        <div class="field">
          <span class="label">연령대</span>
          <div id="ages" class="seg" role="radiogroup" aria-label="연령대">
            <!-- 버튼형 라디오 -->
          </div>
        </div>

        <button type="submit" id="submitBtn" class="button">등록</button>
        <div id="ok" class="success">등록되었습니다. 참여해주셔서 감사합니다!</div>
        <div id="fail" class="error">전송에 문제가 발생했습니다. 다시 시도해 주세요.</div>
        <p class="note">입력하신 정보는 통계 집계 목적에만 사용됩니다. (개인식별정보 수집 없음)</p>
      </form>
    </div>
    <p class="footer">© 달서디지털체험센터</p>
  </div>

  <script>
    // == 설정: 아래에 Google Apps Script Web App URL을 붙여넣으세요 ==
    const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwysbN00pJoAjLoKiUFLRfPdGaL-AwTiFdu7PjiNOlt5MTXSLV9KcTZ5v1-Ca4gZ55YpQ/exec";

    // ─────────────────── 간단한 Client Info (브라우저 정밀 식별) ───────────────────
    async function getClientInfo() {
      const info = { device: 'unknown', os: 'unknown', browser: 'unknown' };
      const ua = navigator.userAgent || '';

      // device & OS (공통 선산정) - 이 부분은 그대로 유지
      info.device = /Mobile|Android|iPhone|iPad|iPod|IEMobile|BlackBerry/i.test(ua) ? 'mobile' : 'desktop';
      if (/Android/i.test(ua)) info.os = 'Android';
      else if (/(iPhone|iPad|iPod)/i.test(ua)) info.os = 'iOS';
      else if (/Windows/i.test(ua)) info.os = 'Windows';
      else if (/Macintosh|Mac OS X/i.test(ua)) info.os = 'macOS';
      else if (/Linux/i.test(ua)) info.os = 'Linux';

      // UA-CH: 브라우저 브랜드 식별
      try {
        if (navigator.userAgentData) {
          // getHighEntropyValues를 사용하여 'fullVersionList'를 요청
          const highEntropyValues = await (navigator.userAgentData.getHighEntropyValues?.(['fullVersionList']) || Promise.resolve({}));
          const brands = highEntropyValues.fullVersionList || navigator.userAgentData.brands || [];
      
          // 브랜드 이름 목록에서 고유 브라우저를 찾음
          for (const brand of brands) {
            const name = brand.brand || '';
            if (/Edge/i.test(name)) { info.browser = 'Edge'; break; }
            if (/Samsung/i.test(name)) { info.browser = 'Samsung Internet'; break; }
            if (/Whale/i.test(name)) { info.browser = 'Whale'; break; }
            if (/Brave/i.test(name)) { info.browser = 'Brave'; break; }
            if (/Opera|OPR/i.test(name)) { info.browser = 'Opera'; break; }
            if (/Chrome/i.test(name)) { info.browser = 'Chrome'; break; }
            if (/Safari/i.test(name)) { info.browser = 'Safari'; break; }
          }
      
          // Brave 특수 처리 (브랜드 리스트에 없을 경우)
          if (info.browser === 'unknown' && navigator.brave) {
            const isBrave = await navigator.brave.isBrave();
            if (isBrave) info.browser = 'Brave';
          }
      
          // 아무것도 찾지 못했고, brands 리스트는 있으나 Generic 브랜드만 있다면 'Chrome'으로 기본값 설정
          if (info.browser === 'unknown' && brands.length > 0 && brands.some(b => /Chromium|Not A Brand/i.test(b.brand))) {
             info.browser = 'Chrome'; // 대부분의 Chromium 기반 브라우저는 Chrome으로 간주
          }
        }
      } catch (e) { /* UA-CH 오류 무시하고 폴백 진행 */ }

      // 폴백: UA 문자열에서 확실히
      if (info.browser === 'unknown' || /Not.*Brand/i.test(info.browser)) {
        info.browser = detectBrowserFromUA(ua);
      }

      return info;
    }

    // normalizeBrand 함수는 더 이상 UA-CH 로직에서 직접 필요하지 않지만,
    // 유지해도 무방합니다. (혹은 삭제 가능)

    function normalizeBrand(name) {
      const n = (name || '').toLowerCase();
      if (n.includes('samsung')) return 'Samsung Internet';
      if (n.includes('google chrome') || n === 'chrome') return 'Chrome';
      if (n.includes('edge')) return 'Edge';
      if (n.includes('whale')) return 'Whale';
      if (n.includes('yabrowser')) return 'Yandex';
      if (n.includes('vivaldi')) return 'Vivaldi';
      if (n.includes('brave')) return 'Brave';
      if (n.includes('opera') || n.includes('opr')) return 'Opera';
      if (n.includes('safari')) return 'Safari';
      return name || 'Unknown';
    }

    function detectBrowserFromUA(ua) {
      // 인앱 브라우저 (가장 먼저)
      if (/KAKAOTALK/i.test(ua)) return 'Kakao In-App';
      if (/NAVER\(inapp/i.test(ua)) return 'Naver In-App';
      if (/FBAN|FBAV/i.test(ua)) return 'Facebook In-App';
      if (/Instagram/i.test(ua)) return 'Instagram In-App';

      // 특정 브라우저 (더 구체적인 것부터)
      if (/SamsungBrowser\//i.test(ua)) return 'Samsung Internet';
      if (/EdgA?\//i.test(ua)) return 'Edge';           // Edge on all platforms
      if (/Whale\//i.test(ua)) return 'Whale';
      if (/YaBrowser\//i.test(ua)) return 'Yandex';
      if (/Vivaldi\//i.test(ua)) return 'Vivaldi';
      if (/Brave\//i.test(ua)) return 'Brave';          // Brave 추가
      if (/OPR\//i.test(ua) || /Opera\//i.test(ua)) return 'Opera';
      if (/Firefox\//i.test(ua)) return 'Firefox';
  
      // iOS 고유의 Chrome/Edge (FxiOS, EdgiOS 등) 처리 - 이미 상단에 CriOS 등이 있음
      if (/CriOS\//i.test(ua)) return 'Chrome';
      if (/FxiOS\//i.test(ua)) return 'Firefox';
      if (/EdgiOS\//i.test(ua)) return 'Edge';
      if (/OPiOS\//i.test(ua)) return 'Opera';

      // 일반적인 브라우저 (가장 마지막)
      if (/Chrome\//i.test(ua)) return 'Chrome';
      if (/Safari\//i.test(ua)) return 'Safari';
  
      return 'Unknown';
    }
    
    // ───────────────────────────────────────────────────────────────────────────

    // 거주지역 버튼 구성
    const regionOptions = ["달서구","달서구외"];
    const regionsEl = document.getElementById('regions');
    let selectedRegion = null;
    regionOptions.forEach(label=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'chip';
      b.textContent = label;
      b.setAttribute('role','radio');
      b.setAttribute('aria-checked','false');
      b.addEventListener('click',()=>{
        selectedRegion = label;
        regionsEl.querySelectorAll('.chip').forEach(c=>{c.classList.remove('selected');c.setAttribute('aria-checked','false')});
        b.classList.add('selected');
        b.setAttribute('aria-checked','true');
      });
      regionsEl.appendChild(b);
    });

    // 연령대 버튼 구성
    const ageOptions = ["유아","초등","중등","고등","성인"];
    const agesEl = document.getElementById('ages');
    let selectedAge = null;
    ageOptions.forEach(label=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'chip';
      b.textContent = label;
      b.setAttribute('role','radio');
      b.setAttribute('aria-checked','false');
      b.addEventListener('click',()=>{
        selectedAge = label;
        agesEl.querySelectorAll('.chip').forEach(c=>{c.classList.remove('selected');c.setAttribute('aria-checked','false')});
        b.classList.add('selected');
        b.setAttribute('aria-checked','true');
      });
      agesEl.appendChild(b);
    });

    // 제출 처리
    const form = document.getElementById('guestbookForm');
    const submitBtn = document.getElementById('submitBtn');
    const ok = document.getElementById('ok');
    const fail = document.getElementById('fail');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      ok.style.display = 'none';
      fail.style.display = 'none';

      if(!selectedRegion){
        alert('거주지역을 선택해 주세요.');
        return;
      }
      if(!selectedAge){
        alert('연령대를 선택해 주세요.');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = '전송 중…';

      try{
        const client = await getClientInfo(); // 간단 요약 정보만 수집
        // 전송 payload (방문일자/시간은 서버에서 결정)
        const payload = {
          region: selectedRegion,
          age: selectedAge,
          client // { device, os, browser }
        };

        // Apps Script의 CORS 제약을 감안해 no-cors 모드 사용.
        await fetch(GAS_WEBAPP_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        ok.style.display = 'block';
        form.reset();
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected'));
        // 선택 상태 초기화
        selectedRegion = null;
        selectedAge = null;
      } catch(err){
        console.error(err);
        fail.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '등록';
      }
    });
  </script>
</body>
</html>
